/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package com.control.factura;

import com.dao.EventManager;
import com.dao.jdbc.DaoHelper;
import com.dao.util.HibernateUtil;
import com.entity.Lichoferes;
import com.entity.Liembarques;
import com.entity.Limotrechazos;
import com.entity.Liusuarios;
import com.sql.SQLCliente;
import com.sql.SQLFacturas;
import com.util.Utilities;
import java.io.IOException;
import java.io.PrintWriter;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.persistence.EntityManager;
import java.io.*;
import java.util.*;
import com.util.*;

/**
 *
 * @author Marco Andrade
 */
public class ctrlFactura extends HttpServlet {

    /** 
     * Processes requests for both HTTP <code>GET</code> and <code>POST</code> methods.
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    protected void processRequest(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=ISO-8859-1");
        response.setHeader("Cache-Control", "no-cache");
        response.setHeader("Pragma", "no-cache");
        response.setDateHeader("Expires", 0L);
        PrintWriter out = response.getWriter();
        try {
            String bnd = Utilities.obtenParametro(request, "bnd");
            switch (Integer.parseInt(bnd)) {
                case 1:
                    out.print(getFactura(request));
                    break;
                case 2:
                    //out.print(buscarFactura(request));
                    out.print(buscarFacturaSPg(request));
                    break;
                case 3:
                    out.print(buscarExistencia(request));
                    break;
                case 4:
                    out.print(buscarFacturas(request));
                    break;
                case 5:
                    out.println(getNoFact(request));
                    break;
            }
        } finally {
            out.close();
        }
    }

    public String getFactura(HttpServletRequest request) {
        String respuesta = "", motivo = "", chofer = "", sqlBusq = "";
        Liusuarios usr = Utilities.ReactivarSession(request);
        if (usr != null) {
            EntityManager em = HibernateUtil.getEntityManager();
            if (!em.getTransaction().isActive()) {
                em.getTransaction().begin();
            }
            try {
                String noFactura = Utilities.obtenParametro(request, "idCnt");
                String bndFact = Utilities.obtenParametro(request, "bndFact");
                Vector vecParams = new Vector();
                vecParams.clear();
                vecParams.add(usr.getUsuempresa());
                if (bndFact.equals("")) {
                    sqlBusq = " and (le.embfolio=" + noFactura + ")";
                } else {
                    if (bndFact.equals("true")) {
                        sqlBusq = " and (le.embfolio=" + noFactura + ")";
                    } else if (bndFact.equals("false")) {
                        sqlBusq = " and (le.embref='" + noFactura + "')";
                    }
                }
                List listFactura = EventManager.getArrayParameter(SQLFacturas.obtFactura(sqlBusq), vecParams);
                if ((listFactura != null) && (!listFactura.isEmpty())) {
                    Object[] obj = (Object[]) (Object[]) listFactura.get(0);
                    respuesta = "{success:true,data:{"
                            + "fchfactura:'" + (obj[0] == null ? "NA" : Fecha.getDateExtJSSQL(obj[0].toString(), "-", "/")) + "',"
                            + "fchpedido:'" + (obj[1] == null ? "NA" : Fecha.getDateExtJSSQL(obj[1].toString(), "-", "/")) + "',"
                            + "referencia:'" + (obj[2] == null ? "NA" : obj[2]) + "',"
                            + "noenvio:'" + (obj[3] == null ? "NA" : obj[3]) + "',"
                            + "nocliente:'" + (obj[4] == null ? "NA" : obj[4]) + " " + (obj[5] == null ? "NA" : (String) obj[5].toString().replaceAll("'", "")) + "',"
                            + "destino:'" + (obj[6] == null ? "NA" : obj[6]) + " " + (obj[7] == null ? "NA" : (String) obj[7].toString().replaceAll("'", "")) + "',"
                            + "nocajas:'" + (obj[8] == null ? "NA" : obj[8]) + "',"
                            + "kilos:'" + (obj[9] == null ? "NA" : obj[9]) + "',"
                            + "importe:'" + (obj[10] == null ? "NA" : obj[10]) + "',"
                            + "Comentarios:'" + (obj[11] == null ? "NA" : obj[11].toString().replaceAll("'", "")) + "',"
                            + "folentrada:'" + (obj[12] == null ? "NA" : obj[12]) + "',"
                            + "fchrecibo:'" + (obj[13] == null ? "NA" : Fecha.getDateExtJSSQL(obj[13].toString(), "-", "/")) + "',"
                            + "guiaempr:'" + (obj[14] == null ? "NA" : obj[14]) + "',"
                            + "ubicacion:'" + (obj[15] == null ? "NA" : obj[15]) + "',"
                            + "entregar:'" + (obj[16] == null ? "NA" : Fecha.getDateExtJSSQL(obj[16].toString(), "-", "/")) + "',"
                            + "fechcancel:'" + (obj[17] == null ? "NA" : Fecha.getDateExtJSSQL(obj[17].toString(), "-", "/")) + "',"
                            + "folembarque:'" + (obj[18] == null ? "NA" : obj[18]) + "',"
                            + "fchembarque:'" + (obj[19] == null ? "NA" : Fecha.getDateExtJSSQL(obj[19].toString(), "-", "/")) + "',";
                    if (obj[24] != null) {
                        Liembarques objEmbarque = (Liembarques) EventManager.getSingleList(Liembarques.class, Integer.parseInt(obj[24].toString()));
                        if (objEmbarque.getEmbchofer() != null) {
                            chofer = objEmbarque.getEmbchofer().getChoclave() + " " + objEmbarque.getEmbchofer().getChonombre() + " " + objEmbarque.getEmbchofer().getChopaterno() + " " + objEmbarque.getEmbchofer().getChomaterno();
                        } else {
                            chofer = "NA";
                        }
                    }
                    respuesta = respuesta + "nombchofer:'" + chofer + "',"
                            + "folentrega:'" + (obj[20] == null ? "NA" : obj[20]) + "',"
                            + "piezas:'" + (obj[21] == null ? "NA" : obj[21]) + "',"
                            + "ar:'" + (obj[22] == null ? "NA" : Fecha.getDateExtJSSQL(obj[22].toString(), "-", "/")) + "',";
                    respuesta = respuesta + "tiprechazo:'" + (obj[23] == null ? "NA" : obj[23].toString().equals("O") ? "Otro" : obj[23].toString().equals("P") == true ? "Rechazo Parcial" : obj[23].toString().equals("T") ? "Rechazo Total" : "NA") + "',";
                    if (obj[24] != null) {
                        Liembarques objEmbarque = (Liembarques) EventManager.getSingleList(Liembarques.class, Integer.parseInt(obj[24].toString()));
                        if (objEmbarque.getEmbconcrechazo() != null) {
                            motivo = objEmbarque.getEmbconcrechazo().getMredescripcion();
                        } else {
                            motivo = "NA";
                        }
                    }
                    respuesta = respuesta + "motivo:'" + (obj[24] == null ? "NA" : motivo) + "',";
                    respuesta = respuesta + "accion:'" + (obj[25] == null ? "NA" : getAccion(obj[25].toString())) + "',";
                    respuesta = respuesta + "foldevdocs:'" + (obj[26] == null ? "NA" : obj[26]) + "',";
                    respuesta = respuesta + "fchdevdocs:'" + (obj[27] == null ? "NA" : Fecha.getDateExtJSSQL(obj[27].toString(), "-", "/")) + "'";
                    respuesta += "}}";
                } else {
                    respuesta = "{success: false,msg: 'No Existe la Factura',accion1:'false',wnd:'idTabFactura'}";
                }
            } catch (Exception e) {
                e.printStackTrace();
                em.getTransaction().rollback();
                respuesta = "{success: false,msg: 'Error en el servidor',accion1:'false',wnd:'idTabFactura'}";
            } finally {
                HibernateUtil.closeSession();
            }
        }
        return respuesta;
    }

    private String buscarFactura(HttpServletRequest request) {
        String record = "{total:0,records:[]}";
        String query1 = "", query2 = "", query3 = "";
        Liusuarios usr = Utilities.ReactivarSession(request);
        if (usr != null) {
            EntityManager em = HibernateUtil.getEntityManager();
            if (!em.getTransaction().isActive()) {
                em.getTransaction().begin();
            }
            try {
                List lst = null;
                List lst2 = null;
                int start = Integer.parseInt(Utilities.obtenParametro(request, "start").equals("") ? "0" : Utilities.obtenParametro(request, "start"));
                int limit = Integer.parseInt(Utilities.obtenParametro(request, "limit").equals("") ? "0" : Utilities.obtenParametro(request, "limit"));
                String fechaIni = Utilities.obtenParametro(request, "fechaIni").replaceAll("'", "");
                String fechaFin = Utilities.obtenParametro(request, "fechaFin").replaceAll("'", "");
                String tipoCliente = Utilities.obtenParametro(request, "tipoCliente").replaceAll("'", "");
                String estatus = Utilities.obtenParametro(request, "estatus");
                String IdStatus = Utilities.obtenParametro(request, "idestatus");
                if (!fechaIni.equals("") && !fechaFin.equals("")) {
                    query1 = " and (trunc(le.embfechafac) between trunc(to_date('" + fechaIni + "')) and trunc(to_date('" + fechaFin + "'))) ";
                }
                if (!tipoCliente.equals("")) {
                    query2 = " and lc.clitipo='" + tipoCliente + "' ";
                }
                if (!IdStatus.equals("")) {
                    query3 = this.getSqlStatus(IdStatus);
                }
                lst = EventManager.getArray(SQLFacturas.BuscarFacturas(query1, query2, query3, usr.getUsuempresa()));
                if (lst != null) {
                    if (!lst.isEmpty()) {
                        record = "{total:" + lst.size() + ",records:[";
                        for (int i = start; (i < start + limit) && (i < lst.size()); i++) {
                            Object[] obj = (Object[]) (Object[]) lst.get(i);
                            record = record + "{";
                            record = record + "elegir:\"<u><a href=# onClick=getDetFactura(" + obj[16] + ") style='color:#1CA4D7; cursor:pointer;'>Elegir</a></u> \" ,";
                            record = record + "estatus:'" + this.status((obj[0] == null ? null : (String) obj[0].toString()), (obj[17] == null ? null : (String) obj[17].toString()), (obj[14] == null ? null : Fecha.getDateExtJSSQL(obj[14].toString(), "-", "/"))) + "',";
                            record = record + "factura:'" + (obj[2] == null ? "NA" : obj[2]) + "',";
                            record = record + "referencia:'" + (obj[2] == null ? "NA" : obj[2]) + "',";
                            record = record + "envio:'" + (obj[3] == null ? "NA" : obj[3]) + "',";
                            record = record + "numCliente:'" + (obj[4] == null ? "NA" : obj[4]) + "',";
                            record = record + "nombCliente:'" + (obj[5] == null ? "NA" : (String) obj[5].toString().replaceAll("'", "")) + "',";
                            record = record + "destino:'" + (obj[7] == null ? "NA" : obj[7]) + "',";
                            record = record + "numCajas:'" + (obj[8] == null ? "NA" : obj[8]) + "',";
                            record = record + "importe:'" + (obj[9] == null ? "NA" : obj[9]) + "',";
                            record = record + "fechFactura:'" + (obj[10] == null ? "NA" : Fecha.getDateExtJSSQL(obj[10].toString(), "-", "/")) + "',";
                            record = record + "fechIngreso:'" + (obj[11] == null ? "NA" : Fecha.getDateExtJSSQL(obj[11].toString(), "-", "/")) + "',";
                            record = record + "cita:'" + (obj[12] == null ? "NA" : Fecha.getDateExtJSSQL(obj[12].toString(), "-", "/")) + "',";
                            record = record + "fechEmbarq:'" + (obj[13] == null ? "NA" : Fecha.getDateExtJSSQL(obj[13].toString(), "-", "/")) + "',";
                            record = record + "fechEntreg:'" + (obj[14] == null ? "NA" : Fecha.getDateExtJSSQL(obj[14].toString(), "-", "/")) + "',";
                            record = record + "comentarios:'" + (obj[15] == null ? "NA" : (String) obj[15].toString().replaceAll("'", "")) + "'";
                            record = record + "},";
                        }
                        record = record.substring(0, record.length() - 1) + "]}";
                    } else {
                        record = "{total:0,records:[]}";
                    }
                } else {
                    record = "{total:0,records:[]}";
                }
            } catch (Exception e) {
                record = "{total:0,records:[]}";
                e.printStackTrace();
                if (em.getTransaction().isActive()) {
                    em.getTransaction().rollback();
                }
            } finally {
                HibernateUtil.closeSession();
            }
        } else {
            record = "{total:getSession(),records:[]}";
        }
        return record;
    }

    private String buscarExistencia(HttpServletRequest request) {
        String record = "{total:0,records:[]}";
        Liusuarios usr = Utilities.ReactivarSession(request);
        if (usr != null) {
            EntityManager em = HibernateUtil.getEntityManager();
            if (!em.getTransaction().isActive()) {
                em.getTransaction().begin();
            }
            try {
                List lst = null;
                ArrayList arrayExistencia = new ArrayList(0);
                arrayExistencia.clear();
                int start = Integer.parseInt(Utilities.obtenParametro(request, "start").equals("") ? "0" : Utilities.obtenParametro(request, "start"));
                int limit = Integer.parseInt(Utilities.obtenParametro(request, "limit").equals("") ? "0" : Utilities.obtenParametro(request, "limit"));
                String idProducts = Utilities.obtenParametro(request, "idProducts").replaceAll("'", "");
                String idAlmacen = Utilities.obtenParametro(request, "idAlmacen").replaceAll("'", "");
                DaoHelper daoHelper = new DaoHelper();
                Vector vecParams = new Vector();
                vecParams.clear();
                vecParams.add(usr.getUsuempresa());
                vecParams.add(Integer.parseInt(idAlmacen));
                if(!idProducts.equals("")){
                idProducts=" and lp.prdclave like '"+idProducts+"%' ";
                }
                arrayExistencia = daoHelper.getResultTable(SQLFacturas.BuscarExistencias(idProducts), vecParams);
                //  lst = EventManager.getArrayParameter(SQLFacturas.BuscarExistencias(), vecParams);
                if (arrayExistencia != null) {
                    if (!arrayExistencia.isEmpty()) {
                        record = "{total:" + arrayExistencia.size() + ",records:[";
                        for (int i = start; (i < start + limit) && (i < arrayExistencia.size()); i++) {
                            Hashtable hashAuxExistencia = new Hashtable();
                            hashAuxExistencia.clear();
                            hashAuxExistencia = (Hashtable) arrayExistencia.get(i);
                            //Object[] obj = (Object[]) (Object[]) lst.get(i);
                            record = record + "{";
                            record = record + "elegir:\"<u><a href=# onClick=getPanelMovimiento(Ext.getCmp('gridConsExistencia').getSelectionModel().getSelected().get('clvProducto')," + (String) hashAuxExistencia.get("INVALMACEN") + ",Ext.getCmp('gridConsExistencia').getSelectionModel().getSelected().get('decripcion')) style='color:#1CA4D7; cursor:pointer;'>Elegir</a></u> \" ,";
                            record = record + "clvProducto:'" + (String) hashAuxExistencia.get("PRDCLAVE") + "',";
                            record = record + "decripcion:'" + (String) hashAuxExistencia.get("PRDDESCRIPCION").toString().replaceAll("'", "") + "',";
                            record = record + "linea:'" + (String) hashAuxExistencia.get("PRDLINEA") + "',";
                            record = record + "familia:'" + (String) hashAuxExistencia.get("PRDFAMILIA") + "',";
                            record = record + "uniAlmacenado:'" + (String) hashAuxExistencia.get("PRDUNIDAD") + "',";
                            record = record + "existReal:'" + (String) hashAuxExistencia.get("INVREAL") + "',";
                            record = record + "existReservada:'" + (String) hashAuxExistencia.get("INVRESEVADO") + "',";
                            record = record + "existDisponible:'" + this.calExDisponible(((String) hashAuxExistencia.get("INVREAL") != null ? (String) hashAuxExistencia.get("INVREAL") : "0"), ((String) hashAuxExistencia.get("INVRESEVADO") != null ? (String) hashAuxExistencia.get("INVRESEVADO") : "0")) + "',";
                            record = record + "almacen:'" + (String) hashAuxExistencia.get("INVALMACEN") + "'";
                            record = record + "},";
                        }
                        record = record.substring(0, record.length() - 1) + "]}";
                    } else {
                        record = "{total:0,records:[]}";
                    }
                } else {
                    record = "{total:0,records:[]}";
                }
            } catch (Exception e) {
                record = "{total:0,records:[]}";
                e.printStackTrace();
                if (em.getTransaction().isActive()) {
                    em.getTransaction().rollback();
                }
            } finally {
                HibernateUtil.closeSession();
            }
        } else {
            record = "{total:getSession(),records:[]}";
        }
        return record;
    }

    public String buscarFacturas(HttpServletRequest request) {
        String record = "";
        EntityManager em = HibernateUtil.getEntityManager();
        Liusuarios usr = Utilities.ReactivarSession(request);
        if (usr != null) {
            try {
                if (!em.getTransaction().isActive()) {
                    em.getTransaction().begin();
                }
                String noFactura = Utilities.obtenParametro(request, "idFact");
                Vector vecParams = new Vector();
                vecParams.clear();
                vecParams.add(usr.getUsuempresa());
                vecParams.add(Integer.parseInt(noFactura));
                List listFactura = EventManager.getArrayParameter(SQLFacturas.ObtenerFacturas(), vecParams);
                if ((listFactura != null) && (!listFactura.isEmpty())) {
                    record = "{total:" + listFactura.size() + ",records:[";
                    for (int i = 0; i < listFactura.size(); i++) {
                        Object[] obj = (Object[]) (Object[]) listFactura.get(i);
                        record = record + "{";
                        record = record + "elegir:\"<u><a href=# onClick=getDetFactura(" + obj[1] + ") style='color:#1CA4D7; cursor:pointer;'>Elegir</a></u> \" ,";
                        record = record + "numFactura:'" + (obj[1] == null ? "NA" : obj[1]) + "',";
                        record = record + "fechFactura:'" + (obj[2] == null ? "NA" : Fecha.getDateExtJSSQL(obj[2].toString(), "-", "/")) + "',";
                        record = record + "numEnvio:'" + (obj[3] == null ? "NA" : obj[3]) + "'";
                        record = record + "},";
                    }
                    record = record.substring(0, record.length() - 1) + "]}";
                } else {
                    record = "{success: false,msg: 'No Existe la Factura',accion1:'false',wnd:'idBuscarFactForm'}";
                }
            } catch (Exception e) {
                e.printStackTrace();
                em.getTransaction().rollback();
                record = "Ext.Msg.alert('¡¡Alerta!!','<center>Se termino la Sesión<center>');";
            } finally {
                HibernateUtil.closeSession();
            }
        }
        return record;
    }

    public String getNoFact(HttpServletRequest request) {
        String json = "", sqlBusq = "";
        EntityManager em = HibernateUtil.getEntityManager();
        Liusuarios usr = Utilities.ReactivarSession(request);
        if (usr != null) {
            try {
                if (!em.getTransaction().isActive()) {
                    em.getTransaction().begin();
                }
                String noFactura = Utilities.obtenParametro(request, "idFact");
                String bndFact = Utilities.obtenParametro(request, "bndFact");
                Vector vecParams = new Vector();
                vecParams.clear();
                vecParams.add(usr.getUsuempresa());
                if (bndFact.equals("")) {
                    sqlBusq = " and (le.embfolio=" + noFactura + ")";
                } else {
                    if (bndFact.equals("true")) {
                        sqlBusq = " and (le.embfolio=" + noFactura + ")";
                    } else if (bndFact.equals("false")) {
                        sqlBusq = " and (le.embref='" + noFactura + "')";
                    }
                }
                List listFactura = EventManager.getArrayParameter(SQLFacturas.ContFacturas(sqlBusq), vecParams);
                if ((listFactura != null) && (!listFactura.isEmpty())) {
                    json = "{success:true,";
                    json += "data:{";
                    json += "nomFactura:" + listFactura.get(0).toString() + "}}";
                } else {
                    json = "{success:false,data:{nomFactura:0}}";
                }
            } catch (Exception e) {
                e.printStackTrace();
                em.getTransaction().rollback();
                json = "{success:false,data:{nomFactura:0}}";
            } finally {
                HibernateUtil.closeSession();
            }
        }
        return json;
    }
     private String buscarFacturaSPg(HttpServletRequest request) {
        String record = "{total:0,records:[]}";
        String query1 = "", query2 = "", query3 = "";
        Liusuarios usr = Utilities.ReactivarSession(request);
        if (usr != null) {
            EntityManager em = HibernateUtil.getEntityManager();
            if (!em.getTransaction().isActive()) {
                em.getTransaction().begin();
            }
            try {
                List lst = null;
                String fechaIni = Utilities.obtenParametro(request, "fechaIni").replaceAll("'", "");
                String fechaFin = Utilities.obtenParametro(request, "fechaFin").replaceAll("'", "");
                String tipoCliente = Utilities.obtenParametro(request, "tipoCliente").replaceAll("'", "");
                String estatus = Utilities.obtenParametro(request, "estatus");
                String IdStatus = Utilities.obtenParametro(request, "idestatus");
                if (!fechaIni.equals("") && !fechaFin.equals("")) {
                    query1 = " and (trunc(le.embfechafac) between trunc(to_date('" + fechaIni + "')) and trunc(to_date('" + fechaFin + "'))) ";
                }
                if (!tipoCliente.equals("")) {
                    query2 = " and lc.clitipo='" + tipoCliente + "' ";
                }
                if (!IdStatus.equals("")) {
                    query3 = this.getSqlStatus(IdStatus);
                }
                lst = EventManager.getArray(SQLFacturas.BuscarFacturas(query1, query2, query3, usr.getUsuempresa()));
                if (lst != null) {
                    if (!lst.isEmpty()) {
                        record = "{total:" + lst.size() + ",records:[";
                        for (int i = 0;i < lst.size(); i++) {
                            Object[] obj = (Object[]) (Object[]) lst.get(i);
                            record = record + "{";
                            record = record + "elegir:\"<u><a href=# onClick=getDetFactura(" + obj[16] + ") style='color:#1CA4D7; cursor:pointer;'>Elegir</a></u> \" ,";
                            record = record + "estatus:'" + this.status((obj[0] == null ? null : (String) obj[0].toString()), (obj[17] == null ? null : (String) obj[17].toString()), (obj[14] == null ? null : Fecha.getDateExtJSSQL(obj[14].toString(), "-", "/"))) + "',";
                            record = record + "factura:'" + (obj[2] == null ? "NA" : obj[2]) + "',";
                            record = record + "referencia:'" + (obj[2] == null ? "NA" : obj[2]) + "',";
                            record = record + "envio:'" + (obj[3] == null ? "NA" : obj[3]) + "',";
                            record = record + "numCliente:'" + (obj[4] == null ? "NA" : obj[4]) + "',";
                            record = record + "nombCliente:'" + (obj[5] == null ? "NA" : (String) obj[5].toString().replaceAll("'", "")) + "',";
                            record = record + "destino:'" + (obj[7] == null ? "NA" : obj[7]) + "',";
                            record = record + "numCajas:'" + (obj[8] == null ? "NA" : obj[8]) + "',";
                            record = record + "importe:'" + (obj[9] == null ? "NA" : obj[9]) + "',";
                            record = record + "fechFactura:'" + (obj[10] == null ? "NA" : Fecha.getDateExtJSSQL(obj[10].toString(), "-", "/")) + "',";
                            record = record + "fechIngreso:'" + (obj[11] == null ? "NA" : Fecha.getDateExtJSSQL(obj[11].toString(), "-", "/")) + "',";
                            record = record + "cita:'" + (obj[12] == null ? "NA" : Fecha.getDateExtJSSQL(obj[12].toString(), "-", "/")) + "',";
                            record = record + "fechEmbarq:'" + (obj[13] == null ? "NA" : Fecha.getDateExtJSSQL(obj[13].toString(), "-", "/")) + "',";
                            record = record + "fechEntreg:'" + (obj[14] == null ? "NA" : Fecha.getDateExtJSSQL(obj[14].toString(), "-", "/")) + "',";
                            record = record + "comentarios:'" + (obj[15] == null ? "NA" : (String) obj[15].toString().replaceAll("'", "")) + "'";
                            record = record + "},";
                        }
                        record = record.substring(0, record.length() - 1) + "]}";
                    } else {
                        record = "{total:0,records:[]}";
                    }
                } else {
                    record = "{total:0,records:[]}";
                }
            } catch (Exception e) {
                record = "{total:0,records:[]}";
                e.printStackTrace();
                if (em.getTransaction().isActive()) {
                    em.getTransaction().rollback();
                }
            } finally {
                HibernateUtil.closeSession();
            }
        } else {
            record = "{total:getSession(),records:[]}";
        }
        return record;
    }

    public String getSqlStatus(String tipo) {
        String sql = "";
        tipo = tipo.replace("'", "");
        if (tipo.equals("S")) {
            sql = " and le.embestatus = 'S' ";
        } else if (tipo.equals("P")) {
            sql = " and le.embestatus = 'P' ";
        } else if (tipo.equals("T")) {
            sql = " and le.embestatus = 'T' and le.embfecentrega is null ";
        } else if (tipo.equals("A")) {
            sql = " and le.embestatus in ('A', 'R') ";
        } else if (tipo.equals("E")) {
            sql = " and le.embestatus = 'E' and NVL(le.embtiporechazo, 'A') not in ('T', 'P') ";
        } else if (tipo.equals("EP")) {
            sql = " and le.embestatus = 'E' and le.embtiporechazo='P' ";
        } else if (tipo.equals("RT")) {
            sql = " and le.embestatus = 'E' and le.embtiporechazo='T' ";
        } else {
            sql = "";
        }
        return sql;
    }

    public String status(String statusF, String tRechazo, String fechEntrega) {
        String estatus = "";
        if (statusF.equals("A")) {
            estatus = "Por Embarcar";
        } else if (statusF.equals("S")) {
            estatus = "Por Surtir";
        } else if (statusF.equals("P")) {
            estatus = "En Surtido";
        } else if (statusF.equals("R")) {
            estatus = "Preembarque";
        } else if (statusF.equals("T")) {
            if (fechEntrega == null) {
                estatus = "En Transito";
            } else {
                if (tRechazo == null) {
                    estatus = "Entregado E/T";
                } else if (tRechazo.equals("P")) {
                    estatus = "Entregado Parcial";
                } else if (tRechazo.equals("T")) {
                    estatus = "Rechazo Total";
                } else {
                    estatus = "Entregado E/T";
                }
            }
        } else if (statusF.equals("E")) {
            if (tRechazo == null) {
                estatus = "Entregado";
            } else if (tRechazo.equals("P")) {
                estatus = "Entregado Parcial";
            } else if (tRechazo.equals("T")) {
                estatus = "Rechazo Total";
            } else {
                estatus = "Entregado";
            }
        } else {
            estatus = "Entregado";
        }
        return estatus;
    }

    public String getAccion(String Accion) {
        String lAccion = "";
        if (Accion.equals("E")) {
            lAccion = "EN ESPERA";
        } else if (Accion.equals("R")) {
            lAccion = "REENVIO";
        } else if (Accion.equals("X")) {
            lAccion = "REEMBARQUE";
        } else if (Accion.equals("C")) {
            lAccion = "CANCELADO";
        } else if (Accion.equals("E")) {
            lAccion = "NA";
        }
        return lAccion;
    }

    public Integer calExDisponible(String real, String reservada) {
        int disp = 0, exReal = 0, exReserd = 0;
        try {
            exReal = Integer.parseInt(real);
            exReserd = Integer.parseInt(reservada);
            disp = exReal - exReserd;
        } catch (Exception e) {
            e.printStackTrace();
            disp = 0;
        }
        return disp;
    }
    // <editor-fold defaultstate="collapsed" desc="HttpServlet methods. Click on the + sign on the left to edit the code.">

    /**
     * Handles the HTTP <code>GET</code> method.
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException,
            IOException {
        processRequest(request, response);
    }

    /**
     * Handles the HTTP <code>POST</code> method.
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException,
            IOException {
        processRequest(request, response);
    }

    /**
     * Returns a short description of the servlet.
     * @return a String containing servlet description
     */
    @Override
    public String getServletInfo() {
        return "Short description";
    }// </editor-fold>
}
